# nk225-data
calculating data



# 日経先物レジサポ分析プロジェクト - 完全仕様書【最終版】

## プロジェクト概要

### 目的

日経先物取引（1時間足）において、価格が反転する（レジサポとなる）ポイントを、各種テクニカル指標から理論的に解明し、最終的にTradingViewのPineScript v6でインジケーターとして実装する。

### 分析のゴール

- 高値・安値で反転が起きた際、どの指標値に最も近かったかを定量的に評価
- 指標ごとのヒット回数、ヒット率、平均誤差、反転強度を算出
- エントリーポイントとして実用的な指標を特定
- 反転の質（成功率、ダマシ率）も評価

-----

## 使用データ

### データファイル

**nk225_1D: 日足データ**
<https://raw.githubusercontent.com/mahoganin-arch/nk225-data/refs/heads/main/nk225_1d.csv>

**nk225_4h: 4時間足データ**
<https://raw.githubusercontent.com/mahoganin-arch/nk225-data/refs/heads/main/nk225_4h.csv>

**nk225_1h_1: 1時間足データ（その1）**
<https://raw.githubusercontent.com/mahoganin-arch/nk225-data/refs/heads/main/nk225_1h_1.csv>

**nk225_1h_2: 1時間足データ（その2）**
<https://raw.githubusercontent.com/mahoganin-arch/nk225-data/refs/heads/main/nk225_1h_2.csv>

**nk225_1h_3: 1時間足データ（その3）**
<https://raw.githubusercontent.com/mahoganin-arch/nk225-data/refs/heads/main/nk225_1h_3.csv>

### データ統合方法

**1時間足データの統合：**

- 3ファイルを**時系列順に単純連結**
- タイムスタンプ重複がある場合は優先順位なし（どちらでも可）
- データ欠損やギャップは後述の方針で対処

### データ形式

```
time, open, high, low, close, Volume
```

- time: Unixタイムスタンプ（秒）
- 価格: 円単位の整数値

-----

## 分析対象指標（確定版）

### 第1段階: 移動平均（60指標）【優先実行】

**SMA（単純移動平均）:**

- 期間: 5, 7, 9, 10, 13, 20, 25, 75, 200, 350
- 時間足: 1H, 4H, 1D
- 合計: 10期間 × 3時間足 = 30指標

**EMA（指数移動平均）:**

- 期間: 5, 7, 9, 10, 13, 20, 25, 75, 200, 350
- 時間足: 1H, 4H, 1D
- 合計: 10期間 × 3時間足 = 30指標

**各時間足での計算方法：**

- 1時間足のSMA/EMA: 1時間足データから計算
- 4時間足のSMA/EMA: 4時間足データから計算
- 日足のSMA/EMA: 日足データから計算

**マルチタイムフレーム参照ルール：**

- 1時間足チャートで分析する際、4時間足、日足の指標値も同時に参照
- **前回確定バーの指標値を使用**（未来データを使わない）
- 例: 1時間足の2024-01-15 10:00のバーで判定する場合
  - 4時間足: 04:00-08:00バーの指標値を使用（08:00-12:00バーは未確定）
  - 日足: 2024-01-14バーの指標値を使用（2024-01-15バーは未確定）

### 第2段階: デイリーピボット（7指標）【第1段階成功後】

**計算方法:**

- 前日の日足データ（高値・安値・終値）から計算
- PP（ピボットポイント）
- R1, R2, R3（レジスタンス）
- S1, S2, S3（サポート）

**計算式:**

```
PP = (前日高値 + 前日安値 + 前日終値) / 3
R1 = 2×PP - 前日安値
R2 = PP + (前日高値 - 前日安値)
R3 = R1 + (前日高値 - 前日安値)
S1 = 2×PP - 前日高値
S2 = PP - (前日高値 - 前日安値)
S3 = S1 - (前日高値 - 前日安値)
```

### 第3段階以降（後続実装）

- フィボナッチリトレースメント（直近20/50/100本の最高値・最安値間）
- ボリンジャーバンド（±0.5σ, ±1σ, ±1.5σ, ±2σ, ±2.5σ）
- 一目均衡表（転換線、基準線、先行スパン1/2、遅行スパン）

-----

## 反転パターンの定義

1時間足の各バーについて、以下の3パターンで反転を判定。

### 重要な共通ルール

1. **すべてのパターンで指標タッチが必須条件**
1. **高値反転では高値（high）のみ使用、安値（low）は使用しない**
1. **安値反転では安値（low）のみ使用、高値（high）は使用しない**
1. **同じバーで複数パターンが成立した場合、別々の反転として記録**

### パターンA: 価格の大幅逆行（3本以内）

#### 高値反転の条件

**i番目のバーが反転ポイントとなる条件：**

1. **指標タッチ（必須）:**

- i番目のバーの高値が指標±閾値の範囲内
  
  ```javascript
  bars[i].high が [指標値-閾値, 指標値+閾値] の範囲内
  ```

1. **150円以上の下落（必須）:**

- i+1、i+2、i+3のいずれかのバーで、i番目の高値から150円以上下落
  
  ```javascript
  bars[i+1].low <= bars[i].high - 150 ||
  bars[i+2].low <= bars[i].high - 150 ||
  bars[i+3].low <= bars[i].high - 150
  ```

1. **高値上抜け禁止（必須）:**

- i+1、i+2、i+3の全バーで、i番目の高値を上抜けない
  
  ```javascript
  bars[i+1].high < bars[i].high &&
  bars[i+2].high < bars[i].high &&
  bars[i+3].high < bars[i].high
  ```

#### 安値反転の条件（対称）

**i番目のバーが反転ポイントとなる条件：**

1. **指標タッチ（必須）:**
   
   ```javascript
   bars[i].low が [指標値-閾値, 指標値+閾値] の範囲内
   ```
1. **150円以上の上昇（必須）:**
   
   ```javascript
   bars[i+1].high >= bars[i].low + 150 ||
   bars[i+2].high >= bars[i].low + 150 ||
   bars[i+3].high >= bars[i].low + 150
   ```
1. **安値下抜け禁止（必須）:**
   
   ```javascript
   bars[i+1].low > bars[i].low &&
   bars[i+2].low > bars[i].low &&
   bars[i+3].low > bars[i].low
   ```

### パターンB: スイング形成

#### 高値反転の条件

**i-2番目のバーが反転ポイントとなる条件：**

1. **指標タッチ（必須）:**
   
   ```javascript
   bars[i-2].high が [指標値-閾値, 指標値+閾値] の範囲内
   ```
1. **高値の切り下げ（必須）:**
   
   ```javascript
   bars[i-1].high < bars[i-2].high &&
   bars[i].high < bars[i-1].high
   ```
   
   ※i-2番目のバーがピーク

#### 安値反転の条件（対称）

**i-2番目のバーが反転ポイントとなる条件：**

1. **指標タッチ（必須）:**
   
   ```javascript
   bars[i-2].low が [指標値-閾値, 指標値+閾値] の範囲内
   ```
1. **安値の切り上げ（必須）:**
   
   ```javascript
   bars[i-1].low > bars[i-2].low &&
   bars[i].low > bars[i-1].low
   ```
   
   ※i-2番目のバーがボトム

### パターンC: 連続陰陽線

#### 高値反転の条件

**i-2番目のバーが反転ポイントとなる条件：**

1. **指標タッチ（必須）:**
   
   ```javascript
   bars[i-2].high が [指標値-閾値, 指標値+閾値] の範囲内
   ```
1. **陰線2本以上連続（必須）:**
   
   ```javascript
   bars[i-1].close < bars[i-1].open &&  // 陰線1本目
   bars[i].close < bars[i].open          // 陰線2本目
   ```
   
   ※i-2番目のバー（陰線が始まる直前）が反転ポイント
1. **高値上抜け禁止（必須）:**

- 陰線が続いている間、i-2番目の高値を上抜けない
  
  ```javascript
  bars[i-1].high < bars[i-2].high &&
  bars[i].high < bars[i-2].high &&
  // 3本目以降も陰線が続く場合は同様にチェック
  ```

1. **重複カウントの防止:**

- 3本以上陰線が連続する場合、最初の2本で成立した反転のみカウント
- 例: i-2で成立済みの場合、i-1やiでは新たな反転としてカウントしない

#### 安値反転の条件（対称）

**i-2番目のバーが反転ポイントとなる条件：**

1. **指標タッチ（必須）:**
   
   ```javascript
   bars[i-2].low が [指標値-閾値, 指標値+閾値] の範囲内
   ```
1. **陽線2本以上連続（必須）:**
   
   ```javascript
   bars[i-1].close > bars[i-1].open &&  // 陽線1本目
   bars[i].close > bars[i].open          // 陽線2本目
   ```
1. **安値下抜け禁止（必須）:**
   
   ```javascript
   bars[i-1].low > bars[i-2].low &&
   bars[i].low > bars[i-2].low &&
   // 3本目以降も陽線が続く場合は同様にチェック
   ```

-----

## ヒット判定の閾値（確定版）

反転ポイントの価格と指標値の差が閾値以内の場合「ヒット」と判定。

### 閾値方式

1. **固定±30円**
1. **固定±50円**

**2パターンのみで比較分析**

### ヒット判定の詳細

**高値反転の場合：**

```javascript
// 反転ポイントのバーの高値が指標±閾値内にあるか
Math.abs(bars[反転ポイント].high - 指標値) <= 閾値
```

**安値反転の場合：**

```javascript
// 反転ポイントのバーの安値が指標±閾値内にあるか
Math.abs(bars[反転ポイント].low - 指標値) <= 閾値
```

**複数指標への同時ヒット：**

- 1つの反転ポイントが複数の指標にヒットする場合、**すべての指標でカウント**

-----

## 反転強度と反転の質の測定

### 1. 反転強度（従来の指標）

反転の「強さ」を定量化する指標。

#### 方法1: 反転後の最大逆行距離（固定10本）

**計測期間:** 反転ポイントのバー（タッチしたバー）から10本後まで

**高値反転の場合:**

```javascript
反転強度 = bars[反転ポイント].high - min(bars[反転ポイント+1 ～ 反転ポイント+10].low)
```

**安値反転の場合:**

```javascript
反転強度 = max(bars[反転ポイント+1 ～ 反転ポイント+10].high) - bars[反転ポイント].low
```

**解釈:**

- プラス値が大きいほど「強い反転」
- 実際のエントリー後の利幅に相当

#### 方法2: ATR正規化した反転強度

```javascript
正規化反転強度 = 反転後の値幅（方法1） / 反転ポイント時点のATR(14)
```

**解釈:**

- 相場のボラティリティに対して標準化された指標
- 例: 0.8 ATR = 小さめの反転、1.5 ATR = 大きな反転

### 2. 反転成功率（追加指標）

指標の「信頼性」を測る指標。

**定義:**

```javascript
反転成功率 = (10本以内に200円以上逆行した回数) / 総反転回数
```

**計測期間:** 反転ポイントのバーから10本後まで

**高値反転の成功判定:**

```javascript
// 10本以内に200円以上下落したか
min(bars[反転ポイント+1 ～ 反転ポイント+10].low) <= bars[反転ポイント].high - 200
```

**安値反転の成功判定:**

```javascript
// 10本以内に200円以上上昇したか
max(bars[反転ポイント+1 ～ 反転ポイント+10].high) >= bars[反転ポイント].low + 200
```

### 3. ダマシ率（追加指標）

反転後すぐに元の方向に戻る「ダマシ」の頻度。

**定義:**

```javascript
ダマシ率 = (反転後5本以内に反転価格を逆抜けした回数) / 総反転回数
```

**高値反転のダマシ判定:**

```javascript
// 5本以内にタッチ時の高値を再度上抜けた
bars[反転ポイント+1].high >= bars[反転ポイント].high ||
bars[反転ポイント+2].high >= bars[反転ポイント].high ||
bars[反転ポイント+3].high >= bars[反転ポイント].high ||
bars[反転ポイント+4].high >= bars[反転ポイント].high ||
bars[反転ポイント+5].high >= bars[反転ポイント].high
```

**安値反転のダマシ判定:**

```javascript
// 5本以内にタッチ時の安値を再度下抜けた
bars[反転ポイント+1].low <= bars[反転ポイント].low ||
bars[反転ポイント+2].low <= bars[反転ポイント].low ||
bars[反転ポイント+3].low <= bars[反転ポイント].low ||
bars[反転ポイント+4].low <= bars[反転ポイント].low ||
bars[反転ポイント+5].low <= bars[反転ポイント].low
```

-----

## 時間帯別フラグ（軽量版）

各反転ポイントに時間帯フラグを付与。ランキングは作成せず、統計サマリーでの簡易比較のみ。

### セッション定義

**デイセッション:**

- 時間帯: 8:45-15:15
- ※注：途中で15:45に変更された可能性あり（変更時期は暫定で全期間8:45-15:15で処理）

**ナイトセッション:**

- 時間帯: 16:30-翌6:00

### 使用方法

- 各反転ポイントのタイムスタンプから時間帯を判定
- 統計サマリーで「デイセッション平均ヒット率」「ナイトセッション平均ヒット率」を比較

-----

## データ欠損への対応方針

### 移動平均計算時

```javascript
// 欠損期間は指標値もnullとする
// 前後のデータから補間はしない
// ヒット判定時は指標値がnullの場合スキップ
```

### 反転判定時

```javascript
// パターンA: 3本以内の判定で、途中にデータ欠損がある場合は
//            その反転ポイント自体を無効とする
// パターンB, C: 同様に必要なバーが欠損している場合は無効
```

-----

## 分析の実行範囲（段階的アプローチ）

### 第1段階実行内容【現在のタスク】

**対象指標:** 移動平均60指標（SMA/EMA × 10期間 × 3時間足）

**対象データ:** 1時間足

**反転パターン:** A, B, Cの3種類

**閾値:** ±30円、±50円の2種類

**分析軸:**

- 反転方向別: 高値反転 / 安値反転 / 統合
- パターン別: A / B / C
- 時間帯別: デイ / ナイト（統計のみ、ランキングなし）

**評価指標:**

- ヒット回数、ヒット率、平均誤差
- 平均反転強度（円）、平均反転強度（ATR）
- 反転成功率（200円基準、10本以内）
- ダマシ率（5本以内）

**含めないもの:**

- 週足指標
- 季節別（Q1-Q3）の集計

### 第2段階以降

成功したら段階的に指標を追加:

1. デイリーピボット（7指標）
1. フィボナッチ（直近20/50/100本）
1. ボリンジャーバンド
1. 一目均衡表

-----

## 出力形式

### 1. ランキング表（Top30）

```markdown
| 順位 | 指標名 | 時間足 | パターン | 閾値 | ヒット回数 | ヒット率(%) | 平均誤差(円) | 平均反転強度(円) | 平均反転強度(ATR) | 反転成功率(%) | ダマシ率(%) |
|------|--------|--------|----------|------|-----------|------------|------------|----------------|-----------------|-------------|-----------|
| 1 | SMA25 | 1D | A | 50 | 127 | 62.3 | 15.2 | 450 | 1.8 | 78.5 | 12.3 |
```

**ソート基準:** ヒット回数が多い順

**表示内容:**

- 全体統合ランキング Top30
- パターン別ランキング（A/B/C各Top20）
- 方向別ランキング（高値反転/安値反転 各Top20）
- 閾値別ランキング（±30円/±50円 各Top20）

### 2. 統計サマリー

```markdown
## 全体統計

### パターン別比較
| パターン | 総反転数 | 指標平均ヒット率(%) | 全指標平均誤差(円) | 平均反転強度(円) | 平均反転強度(ATR) | 平均成功率(%) | 平均ダマシ率(%) |
|---------|---------|------------------|----------------|---------------|-----------------|-------------|--------------|
| A | 1,268 | 15.2 | 18.5 | 420 | 1.65 | 75.2 | 15.8 |
| B | 950 | 12.8 | 16.2 | 380 | 1.52 | 68.5 | 18.3 |
| C | 1,100 | 14.1 | 17.8 | 400 | 1.58 | 72.1 | 16.5 |

### 閾値別比較
| 閾値 | 平均ヒット率(%) | 全指標でのヒット総数 |
|------|---------------|------------------|
| ±30円 | 8.5 | 12,450 |
| ±50円 | 18.2 | 26,780 |

### 方向別比較
| 方向 | 反転数 | 平均ヒット率(%) | 平均反転強度(円) | 平均成功率(%) | 平均ダマシ率(%) |
|------|--------|---------------|---------------|-------------|--------------|
| 高値反転 | 640 | 16.3 | 450 | 76.8 | 14.2 |
| 安値反転 | 628 | 14.8 | 390 | 71.3 | 17.5 |

### 時間帯別比較（簡易版）
| 時間帯 | 反転数 | 平均ヒット率(%) | 平均反転強度(円) |
|--------|--------|---------------|---------------|
| デイセッション | 1,850 | 15.8 | 410 |
| ナイトセッション | 1,468 | 13.2 | 395 |
```

### 3. 詳細CSVデータ

**第1段階では出力しない**（ランキング表とサマリーのみ）

-----

## 技術的な実装詳細

### 移動平均の計算

**SMA（単純移動平均）:**

```javascript
SMA[i] = (Close[i] + Close[i-1] + ... + Close[i-period+1]) / period
```

**EMA（指数移動平均）:**

```javascript
multiplier = 2 / (period + 1)
EMA[i] = (Close[i] - EMA[i-1]) × multiplier + EMA[i-1]
```

### ATR（Average True Range）の計算

```javascript
TR[i] = max(
  High[i] - Low[i],
  |High[i] - Close[i-1]|,
  |Low[i] - Close[i-1]|
)

ATR[i] = (ATR[i-1] × (period-1) + TR[i]) / period
```

※期間は14

### マルチタイムフレーム指標の参照

**例：1時間足の2024-01-15 10:00で4時間足指標を参照**

```javascript
const time1h = bars1h[i].time;  // 2024-01-15 10:00

// 前回確定バーを検索（08:00-12:00バーは未確定なので04:00-08:00を使用）
const idx4h = bars4h.findLastIndex(bar => bar.time <= time1h - 4 * 3600);

// 4時間足のSMA25値を参照
const sma25_4h_value = sma25_4h[idx4h];
```

**例：1時間足の2024-01-15 10:00で日足指標を参照**

```javascript
// 前日確定バーを検索（2024-01-15は未確定なので2024-01-14を使用）
const idx1d = bars1d.findLastIndex(bar => bar.time < time1h - (time1h % 86400));

// 日足のSMA25値を参照
const sma25_1d_value = sma25_1d[idx1d];
```

-----

## 処理フロー

### ステップ1: データ準備

1. 1時間足3ファイル読み込みと時系列順に統合
1. 4時間足データ読み込み
1. 日足データ読み込み
1. ATR(14)計算（各時間足）

### ステップ2: 指標計算

1. 1時間足: SMA/EMA × 10期間 = 20指標
1. 4時間足: SMA/EMA × 10期間 = 20指標
1. 日足: SMA/EMA × 10期間 = 20指標
1. 合計60指標

### ステップ3: 反転ポイント抽出

各パターンで反転検出し、時間帯フラグを付与：

1. パターンA: 推定件数不明（実行後に確定）
1. パターンB: 推定件数不明
1. パターンC: 推定件数不明

### ステップ4: ヒット判定と評価

各反転ポイントについて：

- 60指標 × 2閾値 = 120パターンで判定
- 指標値との差が閾値以内ならヒットとしてカウント
- 誤差、反転強度、成功率、ダマシ率を記録

### ステップ5: 集計とランキング作成

- 指標別にヒット回数、ヒット率を集計
- パターン別、方向別、閾値別、時間帯別にグループ化
- ランキング表と統計サマリーを生成

-----

## 実行時の注意点

### データの制約

- 週足指標は1時間足の反転と粒度が合わないため除外
- 季節別の集計は第1段階では実施しない

### null値の処理

- 移動平均の初期期間（期間-1本）はnullとなるため、ヒット判定時にスキップ
- データ欠損箇所も同様にスキップ

### 近接する反転ポイント

- i番目とi+1番目で別々に反転判定された場合、別々の反転としてカウント
- 同じバーで複数パターンが成立した場合も、別々にカウント

-----

## 補足情報

### 1時間足の特性（推定）

- 推定データ数: 8,000-10,000本程度
- 価格帯: 30,000円 - 45,000円程度
- データ期間: 2021年6月 - 2025年9月

### 4時間足の特性

- 平均ATR: 278.15円
- 価格帯: 30,650円 - 45,710円
- 1日の取引: 6本（24時間 / 4時間）

-----

## 次チャットでの実行内容

1. 上記仕様に基づき、移動平均60指標の完全分析を実行
1. ランキング表と統計サマリーを出力
1. 結果を確認し、必要に応じて閾値や指標範囲を調整
1. 成功したら第2段階（ピボット追加）へ進む
